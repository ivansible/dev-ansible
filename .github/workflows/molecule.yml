---
name: Molecule test
# yamllint disable-line rule:truthy
on:
  push:
    branches:
      - master
    tags:
      - '*'
  pull_request:

env:
  ROLE_NAME: ivansible.dev_ansible
  ANSIBLE_FORCE_COLOR: true
  IVATEST_SSH_SERVER: false
  IVATEST_FIREWALL: none

jobs:
  localhost_test:
    name: test on host
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-16.04
          - ubuntu-18.04
    env:
      SCENARIO: localhost

    steps:
      - name: Checkout
        uses: actions/checkout@master
        with:
          path: ivansible/${{ env.ROLE_NAME }}

      - name: Fix pip issues on ci/cd xenial
        if: ${{ matrix.os == 'ubuntu-16.04' }}
        shell: bash
        run: |
          # stock and pypy flavors of PyYAML are incompatible
          sudo apt-get remove -q -y python3-yaml
          sudo apt-get install -q -y libyaml-dev
          sudo -H pip3 install -U "pip==20.3.3" "setuptools==50.3.2" "wheel==0.36.2"
          sudo -H pip3 install "cryptography==2.9"
          sudo -H pip3 install "pyyaml==5.3.1"

      - name: Upgrade pip on ci/cd bionic
        if: ${{ matrix.os != 'ubuntu-16.04' }}
        shell: bash
        run: |
          sudo apt-get remove -q -y python3-yaml
          sudo -H pip3 install -U pip setuptools wheel

      - name: Install requisites
        shell: bash
        run: |
          # postpone ansible 2.10, molecule 3.2
          sudo -H pip3 install "ansible==2.9.14"
          sudo -H pip3 install "mitogen<0.3"
          sudo -H pip3 install "molecule[docker]<3.2"
          # pull dependencies
          sudo -H pip3 install ansible-lint yamllint flake8
          sudo -H pip3 install boto3 jmespath netaddr pytest testinfra
          sudo -H pip3 install docker

      - name: Run test
        shell: bash
        run: cd ivansible/$ROLE_NAME && molecule test -s $SCENARIO

  docker_test:
    name: tests in docker
    runs-on: ubuntu-18.04
    strategy:
      fail-fast: false
    env:
      SCENARIO: default

    steps:  # copy-pasting above steps since anchors are unsupported
      - name: Checkout
        uses: actions/checkout@master
        with:
          path: ivansible/${{ env.ROLE_NAME }}

      - name: Install requisites
        shell: bash
        run: |
          sudo apt-get remove -q -y python3-yaml
          sudo -H pip3 install -U pip setuptools wheel
          # postpone ansible 2.10, molecule 3.2
          sudo -H pip3 install "ansible==2.9.14"
          sudo -H pip3 install "mitogen<0.3"
          sudo -H pip3 install "molecule[docker]<3.2"
          # pull dependencies
          sudo -H pip3 install ansible-lint yamllint flake8
          sudo -H pip3 install boto3 jmespath netaddr pytest testinfra
          sudo -H pip3 install docker

      - name: Run test
        shell: bash
        run: cd ivansible/$ROLE_NAME && molecule test -s $SCENARIO
...
